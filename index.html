<!DOCTYPE html>
<html>
  <head>
    <title>Earthquakes</title>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="http://d3js.org/topojson.v2.min.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
    <style>

      svg {
        border-width: 1px;
        border-style: solid;
        border-color: black;
      }

    </style>
  </head>
  <body>

    <p>
        <svg id="map" width="1350" height="750"></svg>
        <br>
        <input id="time" type="range" min="1965" max="2016" step="1" value="1965"/>

        <script type="text/javascript">
          var mapSvg = d3.select("#map");

          var projection = d3.geoKavrayskiy7().scale(153);
          var pathGenerator = d3.geoPath().projection(projection);

          var countries;
          var tectonicPlates;
          var database;
          var stats;

          function parseDatabase(row) {
            row.Latitude = +row.Latitude
            row.Longitude = +row.Longitude
          }

          d3.queue()
          .defer(d3.json, "world-50m.json")
          .defer(d3.json, "PB2002_plates.json")
          .defer(d3.tsv, "world-country-names.tsv")
          .defer(d3.csv, "earthquake-database.csv")
          .defer(d3.csv, "earthquake-stats.csv")
          .await(ready);

          function ready(error, world, plates, names, rawDatabase, rawStats) {

            countries = topojson.feature(world, world.objects.countries);
            countries.features = countries.features.filter(function(d) {
              return names.some(function(n) {
                if (d.id == n.id) return d.name = n.name;
              });
            }).sort(function(a, b) {
              return a.name.localeCompare(b.name);
            });


            tectonicPlates = topojson.feature(plates, plates.objects.collection);
            database = rawDatabase;
            stats = rawStats;

            showMap();
          }

          function showMap(year) {
            // Create or modify paths for each country

            projection.fitExtent([[0,0], [mapSvg.attr("width"), mapSvg.attr("height")]], countries);
            pathGenerator = d3.geoPath().projection(projection);

            var tectonicPaths = mapSvg.selectAll("path.tectonic").data(tectonicPlates.features);
            tectonicPaths.enter().append("path").attr("class", "tectonic")
            .merge(tectonicPaths) 
            .transition().duration(1000)
            .style("fill", "white")
            .style("stroke", "blue")
            .style("stroke-width", 1)
            .style("opacity", 0.2)
            .attr("d", function (country) {
              return pathGenerator(country);
            });

            var countryPaths = mapSvg.selectAll("path.country").data(countries.features);
            countryPaths.enter().append("path").attr("class", "country")
            .merge(countryPaths) 
            .transition().duration(1000)
            .style("fill", "white")
            .style("stroke", "black")
            .attr("d", function (country) {
              return pathGenerator(country);
            });

            updateYear(1965);
          }

          function updateYear(year) {

            var year_data = database.filter(function (d) {
              return Number(d.Date.split("/")[2]) == year;
            });

            var circles = mapSvg.selectAll(".year").data(year_data);
            circles.exit().remove()
            circles.enter().append("circle")
            .attr("class", "year")
            .merge(circles)
            .attr("cx", function (d) { return projection([d.Longitude, d.Latitude])[0]; })
            .attr("cy", function (d) { return projection([d.Longitude, d.Latitude])[1]; })
            .attr("r", "4px")
            .attr("fill", "green");
          }

          d3.select("#time").on("input", function() {
            updateYear(+this.value);
          });

        </script>
      </p>

  </body>
</html>